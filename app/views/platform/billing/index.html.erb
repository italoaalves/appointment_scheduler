<div class="space-y-4">
  <%= render "application/shared/page_header",
             title:   t("platform.billing.index.title"),
             subtitle: t("platform.billing.index.subtitle") %>

  <%# Stats cards %>
  <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
    <% [
      [t("platform.billing.index.mrr"), number_to_currency(@mrr_cents / 100.0, unit: "R$", separator: ",", delimiter: "."), "text-slate-700"],
      [t("platform.billing.index.active"), @total_active, "text-emerald-700"],
      [t("platform.billing.index.trialing"), @total_trialing, "text-blue-700"],
      [t("platform.billing.index.expired_canceled"), "#{@total_expired} / #{@total_canceled}", "text-red-700"]
    ].each do |label, value, cls| %>
      <div class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
        <p class="text-xs font-medium text-slate-500"><%= label %></p>
        <p class="mt-1 text-2xl font-bold <%= cls %>"><%= value %></p>
      </div>
    <% end %>
  </div>

  <%# Subscription list %>
  <div class="overflow-hidden rounded-xl border border-slate-200 bg-white shadow-sm">
    <div class="border-b border-slate-200 px-5 py-3">
      <h2 class="text-sm font-semibold text-slate-800"><%= t("platform.billing.index.all_subscriptions") %></h2>
    </div>
    <% if @subscriptions.any? %>
      <table class="min-w-full divide-y divide-slate-200 text-sm">
        <thead class="bg-slate-50">
          <tr>
            <th scope="col" class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-slate-500"><%= t("platform.billing.index.space") %></th>
            <th scope="col" class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-slate-500"><%= t("platform.billing.index.plan") %></th>
            <th scope="col" class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-slate-500"><%= t("platform.billing.index.status") %></th>
            <th scope="col" class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-slate-500"><%= t("platform.billing.index.period") %></th>
            <th scope="col" class="px-4 py-2 text-right text-xs font-semibold uppercase tracking-wide text-slate-500"><%= t("platform.billing.index.override") %></th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-200 bg-white">
          <% @subscriptions.each do |sub| %>
            <tr class="hover:bg-slate-50">
              <td class="px-4 py-2 font-medium text-slate-900">
                <%= link_to sub.space&.name, platform_space_path(sub.space), class: "hover:underline" %>
              </td>
              <td class="px-4 py-2 text-slate-700"><%= sub.plan_id.capitalize %></td>
              <td class="px-4 py-2">
                <%= render "application/shared/status_badge",
                           status: sub.status,
                           label:  sub.status.humanize %>
              </td>
              <td class="px-4 py-2 text-xs text-slate-500">
                <% if sub.current_period_start && sub.current_period_end %>
                  <%= l(sub.current_period_start.to_date, format: :short) %> — <%= l(sub.current_period_end.to_date, format: :short) %>
                <% elsif sub.trial_ends_at %>
                  <%= t("platform.billing.index.trial_ends") %> <%= l(sub.trial_ends_at.to_date, format: :short) %>
                <% else %>
                  —
                <% end %>
              </td>
              <td class="px-4 py-2 text-right">
                <%= link_to t("platform.billing.index.override"), edit_platform_space_subscription_override_path(sub.space),
                            class: "text-xs text-slate-700 hover:underline font-medium" %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
      <div class="px-4 py-3">
        <%= paginate @subscriptions %>
      </div>
    <% else %>
      <p class="px-5 py-4 text-sm text-slate-500"><%= t("platform.billing.index.no_subscriptions") %></p>
    <% end %>
  </div>

  <%# Recent events %>
  <% if @recent_events.any? %>
    <div class="rounded-xl border border-slate-200 bg-white shadow-sm">
      <div class="border-b border-slate-200 px-5 py-3">
        <h2 class="text-sm font-semibold text-slate-800"><%= t("platform.billing.index.recent_events") %></h2>
      </div>
      <ul class="divide-y divide-slate-200">
        <% @recent_events.each do |event| %>
          <li class="flex items-center justify-between gap-4 px-5 py-2.5 text-sm">
            <span class="font-medium text-slate-800"><%= t("billing.event_types.#{event.event_type.tr('.', '_')}", default: event.event_type) %></span>
            <span class="text-slate-500"><%= event.space&.name %></span>
            <span class="text-xs text-slate-400"><%= l(event.created_at, format: :long) %></span>
          </li>
        <% end %>
      </ul>
    </div>
  <% end %>
</div>
