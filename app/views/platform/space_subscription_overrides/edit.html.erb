<% override_actions = capture do %>
  <%= link_to t("platform.subscription_overrides.back"), platform_space_path(@space), class: button_classes(:secondary) %>
<% end %>

<div class="space-y-4">
  <%= render "application/shared/page_header",
             title:   t("platform.subscription_overrides.title"),
             subtitle: t("platform.subscription_overrides.subtitle", name: @space.name),
             actions: override_actions %>

  <%# Current subscription status %>
  <%= render "application/shared/card" do %>
    <h2 class="mb-3 text-sm font-semibold text-slate-800"><%= t("platform.subscription_overrides.current_subscription") %></h2>
    <% if @subscription %>
      <dl class="grid gap-2 text-sm sm:grid-cols-3">
        <div>
          <dt class="text-xs text-slate-500"><%= t("platform.subscription_overrides.plan_label") %></dt>
          <dd class="font-medium text-slate-900"><%= @subscription.billing_plan.name %></dd>
        </div>
        <div>
          <dt class="text-xs text-slate-500"><%= t("platform.spaces.show.subscription.status") %></dt>
          <dd>
            <%= render "application/shared/status_badge",
                       status: @subscription.status,
                       label:  @subscription.status.humanize %>
          </dd>
        </div>
        <div>
          <dt class="text-xs text-slate-500"><%= t("platform.spaces.show.subscription.trial_ends") %></dt>
          <dd class="font-medium text-slate-900"><%= @subscription.trial_ends_at ? l(@subscription.trial_ends_at.to_date, format: :short) : "â€”" %></dd>
        </div>
      </dl>
    <% else %>
      <p class="text-sm text-slate-500"><%= t("platform.subscription_overrides.no_subscription") %></p>
    <% end %>
    <% if @credit %>
      <div class="mt-3 border-t border-slate-100 pt-3">
        <p class="text-xs text-slate-500"><%= t("platform.subscription_overrides.credits_summary", purchased: @credit.balance, quota: @credit.monthly_quota_remaining) %></p>
      </div>
    <% end %>
  <% end %>

  <%# Extend trial %>
  <%= render "application/shared/card" do %>
    <h2 class="mb-3 text-sm font-semibold text-slate-800"><%= t("platform.subscription_overrides.extend_trial") %></h2>
    <%= form_with url: platform_space_subscription_override_path(@space), method: :patch, class: "flex items-end gap-3", data: { turbo_confirm: t("platform.subscription_overrides.confirm_extend") } do |f| %>
      <%= hidden_field_tag :override_action, "extend_trial" %>
      <div class="max-w-xs flex-1">
        <%= label_tag :days, t("platform.subscription_overrides.days_label"), class: form_label_classes %>
        <%= number_field_tag :days, nil, min: 1, placeholder: "e.g. 14", class: form_input_classes("max-w-[8rem]") %>
      </div>
      <button type="submit" class="<%= button_classes(:primary) %>" data-turbo-submits-with="<%= t("shared.submitting") %>"><%= t("platform.subscription_overrides.extend_button") %></button>
    <% end %>
  <% end %>

  <%# Change plan %>
  <%= render "application/shared/card" do %>
    <h2 class="mb-3 text-sm font-semibold text-slate-800"><%= t("platform.subscription_overrides.change_plan") %></h2>
    <%= form_with url: platform_space_subscription_override_path(@space), method: :patch, class: "flex items-end gap-3", data: { turbo_confirm: t("platform.subscription_overrides.confirm_change") } do |f| %>
      <%= hidden_field_tag :override_action, "change_plan" %>
      <div class="max-w-xs flex-1">
        <%= label_tag :plan_id, t("platform.subscription_overrides.plan_label"), class: form_label_classes %>
        <%= select_tag :plan_id, options_for_select(@plans.map { |p| [p.name, p.slug] }, @subscription&.billing_plan&.slug), class: form_input_classes("max-w-[8rem]") %>
      </div>
      <button type="submit" class="<%= button_classes(:secondary) %>" data-turbo-submits-with="<%= t("shared.submitting") %>"><%= t("platform.subscription_overrides.change_button") %></button>
    <% end %>
  <% end %>

  <%# Grant credits %>
  <%= render "application/shared/card" do %>
    <h2 class="mb-3 text-sm font-semibold text-slate-800"><%= t("platform.subscription_overrides.grant_credits") %></h2>
    <%= form_with url: platform_space_subscription_override_path(@space), method: :patch, class: "flex items-end gap-3", data: { turbo_confirm: t("platform.subscription_overrides.confirm_grant") } do |f| %>
      <%= hidden_field_tag :override_action, "grant_credits" %>
      <div class="max-w-xs flex-1">
        <%= label_tag :amount, t("platform.subscription_overrides.amount_label"), class: form_label_classes %>
        <%= number_field_tag :amount, nil, min: 1, placeholder: "e.g. 100", class: form_input_classes("max-w-[8rem]") %>
      </div>
      <button type="submit" class="<%= button_classes(:success) %>" data-turbo-submits-with="<%= t("shared.submitting") %>"><%= t("platform.subscription_overrides.grant_button") %></button>
    <% end %>
  <% end %>
</div>
