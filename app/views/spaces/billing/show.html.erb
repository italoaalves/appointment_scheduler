<div class="space-y-4">
  <%= render "application/shared/page_header",
             title:   t("billing.show.title"),
             subtitle: t("billing.show.subtitle") %>

  <% if @subscription.nil? %>
    <%= render "application/shared/card", padding: "p-6" do %>
      <p class="text-center text-sm text-slate-600"><%= t("billing.show.no_subscription") %></p>
    <% end %>
  <% else %>

    <%# Plan & status card %>
    <%= render "application/shared/card" do %>
      <div class="flex items-start justify-between">
        <div>
          <h2 class="text-sm font-semibold text-slate-800"><%= t("billing.show.current_plan") %></h2>
          <p class="mt-1 text-2xl font-bold text-slate-900"><%= @current_plan&.name %></p>
          <% if @subscription.pending_plan_id.present? %>
            <p class="mt-1 text-sm text-amber-600">
              <%= t("billing.show.pending_downgrade",
                    plan: Billing::Plan.find(@subscription.pending_plan_id).name,
                    date: l(@subscription.current_period_end.to_date, format: :long)) %>
            </p>
          <% end %>
        </div>
        <%= render "application/shared/status_badge",
                   status: @subscription.status,
                   label:  @subscription.status.humanize %>
      </div>

      <% if @subscription.trialing? && @subscription.trial_ends_at %>
        <p class="mt-3 text-sm text-slate-600">
          <%= t("billing.show.trial_ends", date: l(@subscription.trial_ends_at.to_date, format: :long)) %>
        </p>
      <% elsif @subscription.current_period_start && @subscription.current_period_end %>
        <p class="mt-3 text-sm text-slate-600">
          <%= t("billing.show.billing_period",
                from: l(@subscription.current_period_start.to_date, format: :long),
                to:   l(@subscription.current_period_end.to_date, format: :long)) %>
        </p>
      <% end %>

      <% if @subscription.expired? || @subscription.canceled? %>
        <div class="mt-4">
          <%= button_to t("billing.show.resubscribe"), resubscribe_settings_billing_path,
                        method: :patch,
                        class: button_classes(:primary) %>
        </div>
      <% else %>
        <div class="mt-4 flex flex-wrap gap-3">
          <%= link_to t("billing.show.change_plan"), edit_settings_billing_path,
                      class: button_classes(:secondary) %>
          <%= button_to t("billing.show.cancel_subscription"), cancel_settings_billing_path,
                        method: :patch,
                        data: { turbo_confirm: t("billing.show.cancel_confirm") },
                        class: button_classes(:destructive) %>
        </div>
      <% end %>
    <% end %>

    <%# Plan limits summary %>
    <% if @current_plan %>
      <%= render "application/shared/card" do %>
        <h2 class="mb-3 text-sm font-semibold text-slate-800"><%= t("billing.show.plan_limits") %></h2>
        <dl class="grid gap-3 sm:grid-cols-3">
          <div>
            <dt class="text-xs text-slate-500"><%= t("billing.show.team_members") %></dt>
            <dd class="mt-0.5 text-sm font-medium text-slate-900">
              <%= current_tenant.space_memberships.count %> /
              <%= @current_plan.max_team_members == Float::INFINITY ? "∞" : @current_plan.max_team_members %>
            </dd>
          </div>
          <div>
            <dt class="text-xs text-slate-500"><%= t("billing.show.customers") %></dt>
            <dd class="mt-0.5 text-sm font-medium text-slate-900">
              <%= current_tenant.customers.count %> /
              <%= @current_plan.max_customers == Float::INFINITY ? "∞" : @current_plan.max_customers %>
            </dd>
          </div>
          <div>
            <dt class="text-xs text-slate-500"><%= t("billing.show.scheduling_links") %></dt>
            <dd class="mt-0.5 text-sm font-medium text-slate-900">
              <%= current_tenant.scheduling_links.count %> /
              <%= @current_plan.max_scheduling_links == Float::INFINITY ? "∞" : @current_plan.max_scheduling_links %>
            </dd>
          </div>
        </dl>
      <% end %>
    <% end %>

    <%# Payment history %>
    <% if @payments.any? %>
      <div class="overflow-hidden rounded-xl border border-slate-200 bg-white shadow-sm">
        <div class="border-b border-slate-200 px-5 py-3">
          <h2 class="text-sm font-semibold text-slate-800"><%= t("billing.show.payment_history") %></h2>
        </div>
        <table class="min-w-full divide-y divide-slate-200 text-sm">
          <thead class="bg-slate-50">
            <tr>
              <th scope="col" class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-slate-500"><%= t("billing.show.payment_date") %></th>
              <th scope="col" class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-slate-500"><%= t("billing.show.payment_amount") %></th>
              <th scope="col" class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-slate-500"><%= t("billing.show.payment_status") %></th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200 bg-white">
            <% @payments.each do |payment| %>
              <tr class="hover:bg-slate-50">
                <td class="px-4 py-2 text-slate-700">
                  <%= payment.paid_at ? l(payment.paid_at.to_date, format: :long) : "—" %>
                </td>
                <td class="px-4 py-2 text-slate-700">
                  <%= number_to_currency(payment.amount_cents / 100.0, unit: "R$", separator: ",", delimiter: ".") %>
                </td>
                <td class="px-4 py-2">
                  <%= render "application/shared/status_badge",
                             status: payment.status,
                             label:  payment.status.humanize %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>

  <% end %>
</div>
