<% content_for(:breadcrumbs) { render "shared/breadcrumbs", crumbs: [
  { label: t("breadcrumbs.dashboard"), path: root_path },
  { label: t("breadcrumbs.settings"), path: edit_settings_space_path },
  { label: t("breadcrumbs.billing"), path: settings_billing_path },
  { label: t("breadcrumbs.checkout") }
] } %>
<% content_for(:settings_sidebar) do %>
  <%= render "shared/settings_sidebar" %>
<% end %>

<% prices_json = @plans.to_h { |p| [p.slug, p.price_cents] }.to_json %>

<div class="space-y-4"
     x-data="{
       step: 1,
       slug: '',
       isPaid: false,
       prices: <%= prices_json %>,
       pick(s) { this.slug = s; this.isPaid = (this.prices[s] || 0) > 0; this.step = 2; }
     }">

  <%= render "application/shared/page_header",
             title:    t("billing.checkout.title"),
             subtitle: t("billing.checkout.subtitle") %>

  <%= form_with url: subscribe_settings_billing_path, method: :post, class: "space-y-4" do |f| %>
    <input type="hidden" name="plan_id" x-bind:value="slug" />

    <%# ── Step 1: Plan comparison grid ──────────────────────────────────────── %>
    <div x-show="step === 1">
      <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
        <% @plans.each do |plan| %>
          <% is_current = @current_plan&.id == plan.id %>
          <div class="relative flex flex-col rounded-xl border-2 bg-white p-5 shadow-sm
                      <%= plan.highlighted? ? 'border-slate-700' : 'border-slate-200' %>">

            <%# Badges %>
            <div class="mb-3 flex flex-wrap gap-1.5 min-h-[1.5rem]">
              <% if plan.highlighted? %>
                <span class="inline-flex items-center rounded-full bg-slate-800 px-2.5 py-0.5 text-xs font-semibold text-white">
                  ✦ Recomendado
                </span>
              <% end %>
              <% if is_current %>
                <span class="inline-flex items-center rounded-full bg-emerald-100 px-2.5 py-0.5 text-xs font-semibold text-emerald-700">
                  <%= t("billing.edit.current") %>
                </span>
              <% end %>
            </div>

            <%# Name & price %>
            <h2 class="text-lg font-bold text-slate-900"><%= plan.name %></h2>
            <p class="mt-1 text-2xl font-bold text-slate-900">
              <%= number_to_currency(plan.price_cents / 100.0, unit: "R$", separator: ",", delimiter: ".") %>
              <span class="text-sm font-normal text-slate-500">/mês</span>
            </p>

            <%# Feature matrix %>
            <ul class="mt-4 flex-1 space-y-2 border-t border-slate-100 pt-4 text-sm">
              <% BillingHelper::PLAN_COMPARISON_ROWS.each do |row| %>
                <li class="flex items-center justify-between gap-2">
                  <span class="text-slate-500"><%= row[:label] %></span>
                  <span class="font-medium text-slate-900">
                    <% case row[:format]
                       when :limit   then %><%= format_plan_limit(plan.public_send(row[:key])) %><%
                       when :quota   then %><%= format_whatsapp_quota(plan.public_send(row[:key])) %><%
                       when :feature then %><%= format_plan_feature(plan, row[:key]) %><%
                       end %>
                  </span>
                </li>
              <% end %>
            </ul>

            <%# Select button %>
            <div class="mt-5">
              <% if is_current %>
                <button type="button" disabled
                        class="w-full cursor-not-allowed rounded-lg border border-slate-200 bg-slate-50 px-4 py-2.5 text-sm font-medium text-slate-400">
                  <%= t("billing.edit.current") %>
                </button>
              <% else %>
                <button type="button"
                        x-on:click="pick('<%= plan.slug %>')"
                        class="w-full <%= button_classes(:primary) %>">
                  <%= t("billing.edit.select_plan") %>
                </button>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <%# ── Step 2: Payment details ─────────────────────────────────────────── %>
    <div x-show="step === 2" class="space-y-4" style="display:none">

      <%# CPF/CNPJ — required for paid plans %>
      <div x-show="isPaid" class="rounded-xl border border-slate-200 bg-white p-5 shadow-sm">
        <label for="cpf_cnpj" class="mb-1 block text-sm font-semibold text-slate-800">
          <%= t("billing.checkout.cpf_cnpj_label") %>
        </label>
        <input type="text" name="cpf_cnpj" id="cpf_cnpj"
               value="<%= current_user.cpf_cnpj %>"
               inputmode="numeric"
               placeholder="000.000.000-00"
               class="w-full rounded-lg border border-slate-300 px-3 py-2.5 text-sm text-slate-900 shadow-sm placeholder:text-slate-400 focus:border-slate-500 focus:outline-none focus:ring-1 focus:ring-slate-500 sm:max-w-xs" />
        <p class="mt-1 text-xs text-slate-500"><%= t("billing.checkout.cpf_cnpj_hint") %></p>
      </div>

      <%# Payment method — only for paid plans %>
      <div x-show="isPaid" class="rounded-xl border border-slate-200 bg-white p-5 shadow-sm">
        <h2 class="mb-3 text-sm font-semibold text-slate-800"><%= t("billing.checkout.payment_method") %></h2>
        <div class="flex flex-wrap gap-3">
          <% [["pix", t("billing.checkout.pix")], ["credit_card", t("billing.checkout.credit_card")], ["boleto", t("billing.checkout.boleto")]].each_with_index do |(value, label), i| %>
            <label class="flex cursor-pointer items-center gap-2 rounded-lg border px-4 py-2.5 transition
                           has-[:checked]:border-slate-700 has-[:checked]:bg-slate-50 has-[:checked]:text-slate-800
                           border-slate-200 hover:border-slate-300">
              <input type="radio" name="payment_method" value="<%= value %>"
                     <%= i == 0 ? "checked" : "" %>
                     class="h-4 w-4 accent-slate-700" />
              <span class="text-sm font-medium"><%= label %></span>
            </label>
          <% end %>
        </div>
      </div>

      <div class="flex items-center gap-4">
        <button type="button"
                x-on:click="step = 1"
                class="<%= button_classes(:secondary) %>">
          <%= t("billing.checkout.back") %>
        </button>
        <%= f.submit t("billing.checkout.subscribe_button"),
                     class: "#{button_classes(:primary)} cursor-pointer",
                     data: { turbo_submits_with: t("billing.checkout.submit_loading") } %>
      </div>
    </div>

  <% end %>
</div>
