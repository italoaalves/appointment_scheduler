<% content_for(:breadcrumbs) { render "shared/breadcrumbs", crumbs: [
  { label: t("breadcrumbs.dashboard"), path: root_path },
  { label: t("breadcrumbs.settings"), path: edit_settings_space_path },
  { label: t("breadcrumbs.credits") }
] } %>
<% content_for(:settings_sidebar) do %>
  <%= render "shared/settings_sidebar" %>
<% end %>
<div class="space-y-4">
  <%= render "application/shared/page_header",
             title:   t("billing.credits.show.title"),
             subtitle: t("billing.credits.show.subtitle") %>

  <%# Current balance card %>
  <%= render "application/shared/card" do %>
    <h2 class="text-sm font-semibold text-slate-800"><%= t("billing.credits.show.balance_title") %></h2>
    <div class="mt-3 grid gap-4 sm:grid-cols-2">
      <div>
        <p class="text-xs text-slate-500"><%= t("billing.credits.show.purchased_balance") %></p>
        <p class="mt-1 text-2xl font-bold text-slate-900"><%= @credit&.balance || 0 %></p>
      </div>
      <% if @subscription&.plan&.feature?(:whatsapp_included_quota) %>
        <div>
          <p class="text-xs text-slate-500"><%= t("billing.credits.show.monthly_quota") %></p>
          <p class="mt-1 text-2xl font-bold text-slate-900"><%= @credit&.monthly_quota_remaining || 0 %></p>
        </div>
      <% end %>
    </div>
  <% end %>

  <%# Pending purchases â€” shown only when the user has payments awaiting settlement %>
  <% if @pending_purchases.any? %>
    <%= render "application/shared/card" do %>
      <h2 class="mb-3 text-sm font-semibold text-slate-800"><%= t("billing.credits.show.pending_purchases") %></h2>
      <ul class="divide-y divide-slate-200">
        <% @pending_purchases.each do |purchase| %>
          <li class="flex items-center justify-between py-3">
            <div>
              <p class="text-sm font-medium text-slate-900"><%= purchase.amount %> <%= t("billing.credits.show.credits") %></p>
              <p class="text-xs text-slate-400"><%= l(purchase.created_at, format: :long) %></p>
            </div>
            <% if purchase.invoice_url.present? %>
              <%= link_to t("billing.credits.show.pay_now"),
                          purchase.invoice_url,
                          target: "_blank",
                          rel: "noopener noreferrer",
                          class: button_classes(:primary) + " text-sm px-3 py-1.5" %>
            <% end %>
          </li>
        <% end %>
      </ul>
    <% end %>
  <% end %>

  <%# Purchase bundles %>
  <%= render "application/shared/card" do %>
    <h2 class="mb-4 text-sm font-semibold text-slate-800"><%= t("billing.credits.show.purchase_title") %></h2>
    <div class="grid gap-4 sm:grid-cols-3">
      <% @bundles.each do |bundle| %>
        <div class="rounded-lg border border-slate-200 p-4 text-center">
          <p class="text-2xl font-bold text-slate-900"><%= bundle.amount %></p>
          <p class="text-sm text-slate-500"><%= t("billing.credits.show.credits") %></p>
          <p class="mt-1 text-sm font-medium text-slate-700"><%= number_to_currency(bundle.price_cents / 100.0, unit: "R$", separator: ",", delimiter: ".") %></p>
          <%= button_to t("billing.credits.show.purchase"),
                        settings_credits_path,
                        method: :post,
                        params: { amount: bundle.amount },
                        class: "mt-3 w-full #{button_classes(:primary)}" %>
        </div>
      <% end %>
    </div>
  <% end %>

  <%# Credit usage history %>
  <% if @events.any? %>
    <div class="rounded-xl border border-slate-200 bg-white shadow-sm">
      <div class="border-b border-slate-200 px-5 py-3">
        <h2 class="text-sm font-semibold text-slate-800"><%= t("billing.credits.show.history_title") %></h2>
      </div>
      <ul class="divide-y divide-slate-200">
        <% @events.each do |event| %>
          <li class="flex items-center justify-between px-5 py-3">
            <span class="text-sm text-slate-700"><%= billing_event_label(event.event_type) %></span>
            <span class="text-xs text-slate-400"><%= l(event.created_at, format: :long) %></span>
          </li>
        <% end %>
      </ul>
    </div>
  <% else %>
    <%= render "application/shared/empty_state", content: t("billing.credits.show.no_history") %>
  <% end %>
</div>
