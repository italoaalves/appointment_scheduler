<%# Shared partial for availability schedule - usable by Space or future Professional %>
<% schedule = form.object.availability_schedule || form.object.build_availability_schedule %>
<% weekdays = [
  [0, t("space.settings.edit.weekday_sun")],
  [1, t("space.settings.edit.weekday_mon")],
  [2, t("space.settings.edit.weekday_tue")],
  [3, t("space.settings.edit.weekday_wed")],
  [4, t("space.settings.edit.weekday_thu")],
  [5, t("space.settings.edit.weekday_fri")],
  [6, t("space.settings.edit.weekday_sat")]
] %>

<%= form.fields_for :availability_schedule, schedule do |schedule_form| %>
  <% weekday_abbr = [ t("space.settings.edit.weekday_sun"), t("space.settings.edit.weekday_mon"), t("space.settings.edit.weekday_tue"), t("space.settings.edit.weekday_wed"), t("space.settings.edit.weekday_thu"), t("space.settings.edit.weekday_fri"), t("space.settings.edit.weekday_sat") ] %>
  <div class="space-y-6" data-controller="availability-hours" data-availability-hours-weekday-abbr-value='<%= raw weekday_abbr.to_json %>' data-availability-hours-every-day-value="<%= t("space.settings.edit.availability_preset_every_day") %>">
    <div class="rounded-md border border-slate-200 bg-slate-50 p-3">
      <p class="text-xs font-medium uppercase tracking-wide text-slate-500"><%= t("space.availability.edit.business_hours_preview_label") %></p>
      <p class="mt-1 text-sm text-slate-800" data-availability-hours-target="preview"><%= form.object.business_hours.presence || "â€”" %></p>
    </div>
    <div>
      <h3 class="mb-2 text-sm font-medium text-slate-700"><%= t("space.settings.edit.availability_normal_title") %></h3>
      <p class="mb-3 text-xs text-slate-500"><%= t("space.settings.edit.availability_normal_hint") %></p>

      <div class="rounded-md border border-slate-200 bg-slate-50 p-4">
        <div class="flex flex-wrap items-center gap-4">
          <div class="flex items-center gap-2">
            <label for="availability_opens_at" class="text-sm font-medium text-slate-700"><%= t("space.settings.edit.availability_open") %></label>
            <input type="time"
                   id="availability_opens_at"
                   data-availability-hours-target="opensAt"
                   value="09:00"
                   data-action="input->availability-hours#sync change->availability-hours#sync"
                   class="rounded-md border border-slate-300 px-2 py-1.5 text-sm focus:border-slate-500 focus:outline-none focus:ring-1 focus:ring-slate-500"
                   aria-label="<%= t("space.settings.edit.availability_open") %>" />
          </div>
          <div class="flex items-center gap-2">
            <label for="availability_closes_at" class="text-sm font-medium text-slate-700"><%= t("space.settings.edit.availability_close") %></label>
            <input type="time"
                   id="availability_closes_at"
                   data-availability-hours-target="closesAt"
                   value="17:00"
                   data-action="input->availability-hours#sync change->availability-hours#sync"
                   class="rounded-md border border-slate-300 px-2 py-1.5 text-sm focus:border-slate-500 focus:outline-none focus:ring-1 focus:ring-slate-500"
                   aria-label="<%= t("space.settings.edit.availability_close") %>" />
          </div>
        </div>
        <p class="mt-2 text-xs text-slate-500"><%= t("space.settings.edit.availability_open_on") %></p>
        <div class="mt-2 flex flex-wrap gap-3">
          <% weekdays.each do |wday, label| %>
            <label class="inline-flex items-center gap-1.5 text-sm">
              <input type="checkbox"
                     data-availability-hours-target="dayCheckbox"
                     data-weekday="<%= wday %>"
                     data-action="change->availability-hours#sync"
                     class="rounded border-slate-300" />
              <span><%= label %></span>
            </label>
          <% end %>
        </div>
        <div class="mt-3 flex gap-2">
          <button type="button"
                  data-availability-hours-preset="1,2,3,4,5"
                  data-action="click->availability-hours#applyPreset"
                  class="rounded border border-slate-300 bg-white px-2 py-1 text-xs text-slate-600 hover:bg-slate-50">
            <%= t("space.settings.edit.availability_preset_mon_fri") %>
          </button>
          <button type="button"
                  data-availability-hours-preset="1,2,3,4,5,6"
                  data-action="click->availability-hours#applyPreset"
                  class="rounded border border-slate-300 bg-white px-2 py-1 text-xs text-slate-600 hover:bg-slate-50">
            <%= t("space.settings.edit.availability_preset_mon_sat") %>
          </button>
          <button type="button"
                  data-availability-hours-preset="0,1,2,3,4,5,6"
                  data-action="click->availability-hours#applyPreset"
                  class="rounded border border-slate-300 bg-white px-2 py-1 text-xs text-slate-600 hover:bg-slate-50">
            <%= t("space.settings.edit.availability_preset_every_day") %>
          </button>
        </div>
      </div>

      <div class="mt-4">
        <details class="group" data-availability-hours-target="overridesDetails">
          <summary class="cursor-pointer text-sm font-medium text-slate-600 hover:text-slate-800">
            <%= t("space.settings.edit.availability_different_hours") %>
          </summary>
          <p class="mt-2 mb-3 text-xs text-slate-500"><%= t("space.settings.edit.availability_different_hours_hint") %></p>
          <template data-availability-hours-target="overrideTemplate">
            <div class="availability-override-item mb-2 flex flex-wrap items-center gap-2 rounded-md border border-slate-200 bg-white p-3"
                 data-availability-hours-target="overrideItem">
              <select data-availability-hours-target="overrideDay"
                      data-action="change->availability-hours#syncOverrides"
                      class="rounded-md border border-slate-300 px-2 py-1.5 text-sm focus:border-slate-500 focus:outline-none focus:ring-1 focus:ring-slate-500"
                      aria-label="<%= t("space.settings.edit.availability_day") %>">
                <% weekdays.each do |wday, label| %>
                  <option value="<%= wday %>"><%= label %></option>
                <% end %>
              </select>
              <input type="time"
                     data-availability-hours-target="overrideOpens"
                     placeholder="09:00"
                     data-action="input->availability-hours#syncOverrides change->availability-hours#syncOverrides"
                     class="rounded-md border border-slate-300 px-2 py-1.5 text-sm focus:border-slate-500 focus:outline-none focus:ring-1 focus:ring-slate-500"
                     aria-label="<%= t("space.settings.edit.availability_open") %>" />
              <input type="time"
                     data-availability-hours-target="overrideCloses"
                     placeholder="17:00"
                     data-action="input->availability-hours#syncOverrides change->availability-hours#syncOverrides"
                     class="rounded-md border border-slate-300 px-2 py-1.5 text-sm focus:border-slate-500 focus:outline-none focus:ring-1 focus:ring-slate-500"
                     aria-label="<%= t("space.settings.edit.availability_close") %>" />
              <button type="button"
                      data-action="availability-hours#removeOverride"
                      class="text-xs text-red-600 hover:text-red-800">
                <%= t("space.settings.edit.availability_remove_override") %>
              </button>
            </div>
          </template>
          <div data-availability-hours-target="overrideList" class="space-y-2"></div>
          <button type="button"
                  data-action="availability-hours#addOverride"
                  class="mt-2 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xs font-medium text-slate-700 hover:bg-slate-50">
            <%= t("space.settings.edit.availability_add_override") %>
          </button>
        </details>
      </div>

      <div class="sr-only" aria-hidden="true">
        <%= schedule_form.fields_for :availability_windows do |window_form| %>
          <% wday = window_form.object.weekday %>
          <% next unless wday.present? && wday.between?(0, 6) %>
          <div data-availability-hours-target="windowRow" data-weekday="<%= wday %>">
            <%= window_form.hidden_field :weekday %>
            <%= window_form.time_field :opens_at, class: "hidden" %>
            <%= window_form.time_field :closes_at, class: "hidden" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>
