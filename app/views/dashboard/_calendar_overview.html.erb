<div class="flex max-h-[65vh] min-h-0 flex-col rounded-xl border border-slate-200 bg-white shadow-sm"
     x-data="{
       tab: 'today',
       scrollable: false,
       atBottom: false,
       checkOverflow() {
         const el = this.$refs.scrollArea;
         if (!el) return;
         this.scrollable = el.scrollHeight > el.clientHeight;
         this.atBottom = el.scrollTop + el.clientHeight >= el.scrollHeight - 2;
       }
     }"
     x-init="$nextTick(() => { checkOverflow(); const el = $refs.scrollArea; const self = this; if (el) new ResizeObserver(() => self.$nextTick(() => self.checkOverflow())).observe(el); })">
  <div class="shrink-0 border-b border-slate-200">
    <nav class="flex -mb-px">
      <button type="button"
              @click="tab = 'today'; $nextTick(() => checkOverflow())"
              :class="tab === 'today' ? 'border-slate-900 text-slate-900' : 'border-transparent text-slate-500 hover:border-slate-300 hover:text-slate-700'"
              class="border-b-2 px-4 py-3 text-sm font-medium">
        <%= t("admin.appointments.calendar.today") %>
      </button>
      <button type="button"
              @click="tab = 'week'; $nextTick(() => checkOverflow())"
              :class="tab === 'week' ? 'border-slate-900 text-slate-900' : 'border-transparent text-slate-500 hover:border-slate-300 hover:text-slate-700'"
              class="border-b-2 px-4 py-3 text-sm font-medium">
        <%= t("admin.appointments.calendar.week") %>
      </button>
      <button type="button"
              @click="tab = 'month'; $nextTick(() => checkOverflow())"
              :class="tab === 'month' ? 'border-slate-900 text-slate-900' : 'border-transparent text-slate-500 hover:border-slate-300 hover:text-slate-700'"
              class="border-b-2 px-4 py-3 text-sm font-medium">
        <%= t("admin.appointments.calendar.month") %>
      </button>
    </nav>
  </div>

  <div class="relative min-h-0 flex-1 flex flex-col">
    <div x-ref="scrollArea"
         class="min-h-0 flex-1 overflow-y-auto p-4"
         @scroll="checkOverflow()">
      <% %i[today week month].each do |period| %>
        <% appointments = instance_variable_get("@calendar_#{period}") %>
        <div x-show="tab === '<%= period %>'"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             style="<%= period == :today ? '' : 'display: none;' %>"
             class="space-y-4">
          <% if appointments.any? %>
            <% case period %>
            <% when :today %>
              <% today_groups = calendar_today_grouped(appointments, @calendar_space).select { |_, v| v.any? } %>
              <% today_groups.each_with_index do |(period_key, group_appointments), idx| %>
                <div class="<%= idx < today_groups.size - 1 ? 'pb-4 mb-4 border-b border-slate-200' : '' %>">
                  <p class="mb-2 text-xs font-semibold uppercase tracking-wide text-slate-500">
                    <%= t("admin.appointments.calendar.periods.#{period_key}") %>
                  </p>
                  <ul class="space-y-0">
                    <% group_appointments.each do |appointment| %>
                      <li>
                        <%= render "dashboard/calendar_appointment", appointment: appointment %>
                      </li>
                    <% end %>
                  </ul>
                </div>
              <% end %>
            <% when :week, :month %>
              <% grouped = period == :week ? calendar_week_grouped(appointments, @calendar_space) : calendar_month_grouped(appointments, @calendar_space) %>
              <% today_in_space = Time.current.in_time_zone(TimezoneResolver.zone(@calendar_space)).to_date %>
              <% grouped.each_with_index do |(date, group_appointments), idx| %>
                <div class="<%= idx < grouped.size - 1 ? 'pb-4 mb-4 border-b border-slate-200' : '' %>">
                  <p class="mb-2 text-xs font-semibold uppercase tracking-wide <%= date == today_in_space ? 'text-indigo-600' : 'text-slate-500' %>">
                    <%= date.strftime("%A, %b %d") %><% if date == today_in_space %><span class="ml-1 font-normal normal-case text-indigo-500">(Today)</span><% end %>
                  </p>
                  <ul class="space-y-0">
                    <% group_appointments.sort_by { |a| a.scheduled_at || Time.zone.at(0) }.each do |appointment| %>
                      <li>
                        <%= render "dashboard/calendar_appointment", appointment: appointment %>
                      </li>
                    <% end %>
                  </ul>
                </div>
              <% end %>
            <% end %>
          <% else %>
            <div class="py-6 text-center">
              <p class="text-sm text-slate-500">
                <%= t("dashboard.empty_calendar.message") %>
              </p>
              <% if current_tenant.personalized_scheduling_link.present? %>
                <% empty_booking_url = book_by_slug_url(slug: current_tenant.personalized_scheduling_link.slug) %>
                <div class="mt-3" data-controller="clipboard">
                  <code data-clipboard-target="source" class="hidden"><%= empty_booking_url %></code>
                  <span data-clipboard-target="feedback" class="hidden text-sm font-medium text-emerald-600"><%= t("onboarding.step3.copied") %></span>
                  <button type="button"
                          data-action="click->clipboard#copy"
                          class="<%= button_classes(:primary) %> mt-2">
                    <%= t("dashboard.empty_calendar.copy_link") %>
                  </button>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <div x-show="scrollable && !atBottom"
         x-transition:enter="transition ease-out duration-150"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-100"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="pointer-events-none absolute left-0 right-0 z-10 h-8 bg-gradient-to-t from-white via-white/80 to-transparent"
         style="display: none; bottom: 52px;">
    </div>

    <footer class="shrink-0 border-t border-slate-100 bg-white px-4 py-3">
      <% %i[today week month].each do |period| %>
        <% stats = instance_variable_get("@stats_#{period}") %>
        <div x-show="tab === '<%= period %>'"
             x-transition:enter="transition ease-out duration-150"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             class="flex flex-wrap gap-4 text-xs text-slate-600"
             style="<%= period == :today ? '' : 'display: none;' %>">
          <span><%= t("admin.appointments.calendar.stats.total") %>: <strong class="text-slate-900"><%= stats[:total] %></strong></span>
          <span><%= t("admin.appointments.calendar.stats.empty_slots") %>: <strong class="text-slate-900"><%= stats[:empty_slots] %></strong></span>
          <span><%= t("admin.appointments.calendar.stats.pending") %>: <strong class="text-amber-700"><%= stats[:pending] %></strong></span>
          <span><%= t("admin.appointments.calendar.stats.confirmed") %>: <strong class="text-emerald-700"><%= stats[:confirmed] %></strong></span>
        </div>
      <% end %>
    </footer>
  </div>
</div>
