<div class="rounded-xl border border-slate-200 bg-white shadow-sm" x-data="{ tab: 'today' }">
  <div class="border-b border-slate-200">
    <nav class="flex -mb-px">
      <button type="button"
              @click="tab = 'today'"
              :class="tab === 'today' ? 'border-slate-900 text-slate-900' : 'border-transparent text-slate-500 hover:border-slate-300 hover:text-slate-700'"
              class="border-b-2 px-4 py-3 text-sm font-medium">
        <%= t("admin.appointments.calendar.today") %>
      </button>
      <button type="button"
              @click="tab = 'week'"
              :class="tab === 'week' ? 'border-slate-900 text-slate-900' : 'border-transparent text-slate-500 hover:border-slate-300 hover:text-slate-700'"
              class="border-b-2 px-4 py-3 text-sm font-medium">
        <%= t("admin.appointments.calendar.week") %>
      </button>
      <button type="button"
              @click="tab = 'month'"
              :class="tab === 'month' ? 'border-slate-900 text-slate-900' : 'border-transparent text-slate-500 hover:border-slate-300 hover:text-slate-700'"
              class="border-b-2 px-4 py-3 text-sm font-medium">
        <%= t("admin.appointments.calendar.month") %>
      </button>
    </nav>
  </div>

  <div class="p-4">
    <% %i[today week month].each do |period| %>
      <% appointments = instance_variable_get("@calendar_#{period}") %>
      <% stats = instance_variable_get("@stats_#{period}") %>
      <div x-show="tab === '<%= period %>'"
           x-transition:enter="transition ease-out duration-200"
           x-transition:enter-start="opacity-0"
           x-transition:enter-end="opacity-100"
           style="<%= period == :today ? '' : 'display: none;' %>"
           class="space-y-4">
        <% if appointments.any? %>
          <% case period %>
          <% when :today %>
            <% today_groups = calendar_today_grouped(appointments).select { |_, v| v.any? } %>
            <% today_groups.each_with_index do |(period_key, group_appointments), idx| %>
              <div class="<%= idx < today_groups.size - 1 ? 'pb-4 mb-4 border-b border-slate-200' : '' %>">
                <p class="mb-2 text-xs font-semibold uppercase tracking-wide text-slate-500">
                  <%= t("admin.appointments.calendar.periods.#{period_key}") %>
                </p>
                <ul class="space-y-0">
                  <% group_appointments.each do |appointment| %>
                    <li>
                      <%= render "dashboard/calendar_appointment", appointment: appointment %>
                    </li>
                  <% end %>
                </ul>
              </div>
            <% end %>
          <% when :week, :month %>
            <% grouped = period == :week ? calendar_week_grouped(appointments) : calendar_month_grouped(appointments) %>
            <% grouped.each_with_index do |(date, group_appointments), idx| %>
              <div class="<%= idx < grouped.size - 1 ? 'pb-4 mb-4 border-b border-slate-200' : '' %>">
                <p class="mb-2 text-xs font-semibold uppercase tracking-wide text-slate-500">
                  <%= date.strftime("%A, %b %d") %>
                </p>
                <ul class="space-y-0">
                  <% group_appointments.sort_by { |a| a.scheduled_at || Time.zone.at(0) }.each do |appointment| %>
                    <li>
                      <%= render "dashboard/calendar_appointment", appointment: appointment %>
                    </li>
                  <% end %>
                </ul>
              </div>
            <% end %>
          <% end %>
        <% else %>
          <p class="py-6 text-center text-sm text-slate-500">
            <%= t("admin.appointments.calendar.no_appointments") %>
          </p>
        <% end %>

        <footer class="flex flex-wrap gap-4 pt-2 border-t border-slate-100 text-xs text-slate-600">
          <span><%= t("admin.appointments.calendar.stats.total") %>: <strong class="text-slate-900"><%= stats[:total] %></strong></span>
          <span><%= t("admin.appointments.calendar.stats.empty_slots") %>: <strong class="text-slate-900"><%= stats[:empty_slots] %></strong></span>
          <span><%= t("admin.appointments.calendar.stats.pending") %>: <strong class="text-amber-700"><%= stats[:pending] %></strong></span>
          <span><%= t("admin.appointments.calendar.stats.confirmed") %>: <strong class="text-emerald-700"><%= stats[:confirmed] %></strong></span>
        </footer>
      </div>
    <% end %>
  </div>
</div>
